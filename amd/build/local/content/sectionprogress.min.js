define("format_mawang/local/content/sectionprogress",["exports","core/reactive","core_courseformat/courseeditor","core/templates"],(function(_exports,_reactive,_courseeditor,_templates){var obj;
/**
   * Reactive component to show the course progress.
   *
   * @module     format_mawang/local/content/sectionprogress
   * @copyright  2024 Bas Brands <bas@sonsbeekmedia.nl>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_templates=(obj=_templates)&&obj.__esModule?obj:{default:obj};class Component extends _reactive.BaseComponent{create(){this.name="courseprogress",this.selectors={CONTAINER:'[data-region="courseprogress"]',DESTINATION:'[data-region="mawang-extra"]'},this.classes={PROGRESSHIDDEN:"d-none"},this.wrapper=null,this.progress=null}static init(target,selectors){return this.addEvents(),new Component({element:document.getElementById(target),reactive:(0,_courseeditor.getCurrentCourseEditor)(),selectors:selectors})}stateReady(state){this.wrapper=this.getElement(),this._refreshCompletion({state:state})}async _refreshCompletion(_ref){let{state:state}=_ref;if(this.reactive.isEditing)return;const containers=this.getElements(this.selectors.CONTAINER),items=this.reactive.getExporter().allItemsArray(this.reactive.state),exporter=this.reactive.getExporter();if(0===items.length)return;const rootsections=[],allsections=[];items.forEach((item=>{if("section"==item.type){const section=state.section.get(item.id);allsections.push(section)}})),allsections.forEach((section=>{rootsections[section.id]={total:0,completed:0,subsections:[]}})),items.every((item=>{if("cm"==item.type){const cm=state.cm.get(item.id),rootid=cm.sectionid;if(!1===cm.visible||!1===cm.uservisible)return!0;const data=exporter.cmCompletion(state,cm);if(!0!==data.hasstate)return!0;rootsections[rootid].total++,data.iscomplete&&rootsections[rootid].completed++}return!0})),containers.forEach((async container=>{if(rootsections[container.dataset.id]){const completed=rootsections[container.dataset.id].completed,total=rootsections[container.dataset.id].total;if(container.dataset.subsections=rootsections[container.dataset.id].subsections.join(","),0===total)return;const progress=Math.round(completed/total*100),circumference=2*Math.PI*35,dashoffset=circumference-progress/100*circumference,{html:html,js:js}=await _templates.default.renderForPromise("format_mawang/local/content/progress",{progress:progress,dashoffset:dashoffset,circumference:circumference,completed:completed,total:total});if(null!==this.reactive.sectionReturn){const mawangContainer=document.querySelector(this.selectors.DESTINATION);mawangContainer&&(mawangContainer.classList.remove(this.classes.PROGRESSHIDDEN),_templates.default.replaceNodeContents(mawangContainer,html,js))}else _templates.default.replaceNodeContents(container,html,js)}}))}getWatchers(){return[{watch:"cm:updated",handler:this._refreshCompletion}]}static addEvents(){document.addEventListener("click",(event=>{if(event.target.closest('[data-action="progressmoreinfo"]')){event.preventDefault();document.querySelector('[data-region="progressmoretodo"]').classList.toggle("show")}}))}}return _exports.default=Component,_exports.default}));

//# sourceMappingURL=sectionprogress.min.js.map