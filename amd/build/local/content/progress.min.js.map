{"version":3,"file":"progress.min.js","sources":["../../../src/local/content/progress.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Reactive component to show the course progress.\n *\n * @module     format_mawang/local/content/sectionprogress\n * @copyright  2024 Bas Brands <bas@sonsbeekmedia.nl>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\nimport Templates from 'core/templates';\n\nexport default class Component extends BaseComponent {\n\n    /**\n     * Constructor hook.\n     */\n    create() {\n        // Optional component name for debugging.\n        this.name = 'courseprogress';\n        // Default query selectors.\n        this.selectors = {\n            PROGRESSCONTAINER: `[data-region=\"courseprogresscontainer\"]`,\n            DESTINATION: `[data-region=\"mawang-extra\"]`,\n        };\n\n        // Default classes to toggle on refresh.\n        this.classes = {\n            PROGRESSHIDDEN: 'd-none',\n        };\n        // Arrays to keep cms and sections elements.\n        this.wrapper = null;\n        this.progress = null;\n    }\n\n    /**\n     * Static method to create a component instance form the mustache template.\n     *\n     * @param {element|string} target the DOM main element or its ID\n     * @param {object} selectors optional css selector overrides\n     * @return {Component}\n     */\n    static init(target, selectors) {\n        this.addEvents();\n        return new Component({\n            element: document.getElementById(target),\n            reactive: getCurrentCourseEditor(),\n            selectors,\n        });\n    }\n\n    /**\n     * Initial state ready method.\n     *\n     * @param {Object} state the state data\n     */\n    stateReady(state) {\n\n        // Get cms and sections elements.\n        this.wrapper = this.getElement();\n\n        this._refreshCompletion({state: state});\n    }\n\n\n    /**\n     * Update course completion based on the completion of the cms in the sections\n     *\n     * @param {Object} param details the update details.\n     * @param {Object} param.state the state data.\n     */\n    async _refreshCompletion({state}) {\n        if (this.reactive.isEditing) {\n            return;\n        }\n\n        const container = document.querySelector(this.selectors.PROGRESSCONTAINER);\n\n        if (!container) {\n            return;\n        }\n        const items = this.reactive.getExporter().allItemsArray(this.reactive.state);\n        const exporter = this.reactive.getExporter();\n        if (items.length === 0) {\n            return;\n        }\n        const rootsections = [];\n        const allsections = [];\n        items.forEach((item) => {\n            if (item.type == 'section') {\n                const section = state.section.get(item.id);\n                allsections.push(section);\n            }\n        });\n\n        allsections.forEach((section) => {\n            rootsections[section.id] = {\n                total: 0,\n                completed: 0,\n                subsections: [],\n            };\n        });\n\n        items.every((item) => {\n            if (item.type == 'cm') {\n                const cm = state.cm.get(item.id);\n                // Find the root section of the cm.\n                const rootid = cm.sectionid;\n                if (cm.visible === false || cm.uservisible === false) {\n                    return true;\n                }\n                const data = exporter.cmCompletion(state, cm);\n                if (data.hasstate !== true) {\n                    return true;\n                }\n\n                rootsections[rootid].total++;\n                if (data.iscomplete) {\n                    rootsections[rootid].completed++;\n                }\n            }\n            return true;\n        });\n\n        if (rootsections[container.dataset.id]) {\n            const completed = rootsections[container.dataset.id].completed;\n            const total = rootsections[container.dataset.id].total;\n            container.dataset.subsections = rootsections[container.dataset.id].subsections.join(',');\n            if (total === 0) {\n                return;\n            }\n\n            const progress = Math.round((completed / total) * 100);\n\n            if (progress !== container.dataset.progress) {\n\n                const {html, js} = await Templates.renderForPromise('format_mawang/local/content/progress',\n                    {\n                        'progress': progress,\n                        'sectionid': container.dataset.id,\n                    }\n                );\n\n                Templates.replaceNode(container, html, js);\n            }\n\n        }\n    }\n\n    /**\n     * Component watchers.\n     *\n     * @returns {Array} of watchers\n     */\n    getWatchers() {\n        return [\n            {watch: `cm:updated`, handler: this._refreshCompletion},\n        ];\n    }\n\n    /**\n     * Add events to the component.\n     */\n    static addEvents() {\n        document.addEventListener('click', (event) => {\n            if (event.target.closest('[data-action=\"progressmoreinfo\"]')) {\n                event.preventDefault();\n                const todo = document.querySelector('[data-region=\"progressmoretodo\"]');\n                todo.classList.toggle('show');\n            }\n        });\n    }\n}"],"names":["Component","BaseComponent","create","name","selectors","PROGRESSCONTAINER","DESTINATION","classes","PROGRESSHIDDEN","wrapper","progress","target","addEvents","element","document","getElementById","reactive","stateReady","state","this","getElement","_refreshCompletion","isEditing","container","querySelector","items","getExporter","allItemsArray","exporter","length","rootsections","allsections","forEach","item","type","section","get","id","push","total","completed","subsections","every","cm","rootid","sectionid","visible","uservisible","data","cmCompletion","hasstate","iscomplete","dataset","join","Math","round","html","js","Templates","renderForPromise","replaceNode","getWatchers","watch","handler","addEventListener","event","closest","preventDefault","classList","toggle"],"mappings":";;;;;;;yJA2BqBA,kBAAkBC,wBAKnCC,cAESC,KAAO,sBAEPC,UAAY,CACbC,4DACAC,iDAICC,QAAU,CACXC,eAAgB,eAGfC,QAAU,UACVC,SAAW,iBAURC,OAAQP,uBACXQ,YACE,IAAIZ,UAAU,CACjBa,QAASC,SAASC,eAAeJ,QACjCK,UAAU,0CACVZ,UAAAA,YASRa,WAAWC,YAGFT,QAAUU,KAAKC,kBAEfC,mBAAmB,CAACH,MAAOA,2CAUXA,MAACA,eAClBC,KAAKH,SAASM,uBAIZC,UAAYT,SAASU,cAAcL,KAAKf,UAAUC,uBAEnDkB,uBAGCE,MAAQN,KAAKH,SAASU,cAAcC,cAAcR,KAAKH,SAASE,OAChEU,SAAWT,KAAKH,SAASU,iBACV,IAAjBD,MAAMI,oBAGJC,aAAe,GACfC,YAAc,MACpBN,MAAMO,SAASC,UACM,WAAbA,KAAKC,KAAmB,OAClBC,QAAUjB,MAAMiB,QAAQC,IAAIH,KAAKI,IACvCN,YAAYO,KAAKH,aAIzBJ,YAAYC,SAASG,UACjBL,aAAaK,QAAQE,IAAM,CACvBE,MAAO,EACPC,UAAW,EACXC,YAAa,OAIrBhB,MAAMiB,OAAOT,UACQ,MAAbA,KAAKC,KAAc,OACbS,GAAKzB,MAAMyB,GAAGP,IAAIH,KAAKI,IAEvBO,OAASD,GAAGE,cACC,IAAfF,GAAGG,UAAwC,IAAnBH,GAAGI,mBACpB,QAELC,KAAOpB,SAASqB,aAAa/B,MAAOyB,QACpB,IAAlBK,KAAKE,gBACE,EAGXpB,aAAac,QAAQL,QACjBS,KAAKG,YACLrB,aAAac,QAAQJ,mBAGtB,KAGPV,aAAaP,UAAU6B,QAAQf,IAAK,OAC9BG,UAAYV,aAAaP,UAAU6B,QAAQf,IAAIG,UAC/CD,MAAQT,aAAaP,UAAU6B,QAAQf,IAAIE,SACjDhB,UAAU6B,QAAQX,YAAcX,aAAaP,UAAU6B,QAAQf,IAAII,YAAYY,KAAK,KACtE,IAAVd,mBAIE7B,SAAW4C,KAAKC,MAAOf,UAAYD,MAAS,QAE9C7B,WAAaa,UAAU6B,QAAQ1C,SAAU,OAEnC8C,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,uCAChD,UACgBjD,mBACCa,UAAU6B,QAAQf,wBAI7BuB,YAAYrC,UAAWiC,KAAMC,MAWnDI,oBACW,CACH,CAACC,mBAAqBC,QAAS5C,KAAKE,wCAQxCP,SAASkD,iBAAiB,SAAUC,WAC5BA,MAAMtD,OAAOuD,QAAQ,oCAAqC,CAC1DD,MAAME,iBACOrD,SAASU,cAAc,oCAC/B4C,UAAUC,OAAO"}